<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Entreprise ENPIWEN</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #graph-container {
            display: flex;
            flex-direction: column; /* Graphiques en colonne */
            align-items: center; /* Centrage horizontal */
            gap: 20px; /* Espace entre les graphiques */
        }

        .graph-box {
            width: 70%; /* Taille plus grande */
            max-width: 600px;
            padding: 15px;
            border: 1px solid #ccc; /* Bordure pour s√©paration */
            border-radius: 10px;
            background-color: #f9f9f9;
            text-align: center;
        }

        canvas {
            width: 100% !important;
            height: 300px !important; /* Taille augment√©e */
        }
    </style>
    <script>
        $(document).ready(function () {
            var temperatureChart = new Chart(document.getElementById('temperatureChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Temp√©rature', data: [], borderColor: 'red', fill: false }] }
            });

            var humiditeChart = new Chart(document.getElementById('humiditeChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Humidit√©', data: [], borderColor: 'blue', fill: false }] }
            });

            var volumeChart = new Chart(document.getElementById('volumeChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Volume sonore', data: [], borderColor: 'green', fill: false }] }
            });

            // üü¢ √âtape 1 : Charger imm√©diatement les 10 derni√®res valeurs au d√©marrage
            function loadInitialData() {
                $.getJSON('/data', function(data) {
                    var now = new Date();
                    var labels = [];

                    for (var i = 9; i >= 0; i--) {
                        labels.push(new Date(now - i * 2000).toLocaleTimeString());  // Cr√©e des timestamps fictifs pour les 10 derni√®res valeurs
                    }

                    // Initialisation des graphiques avec les 10 derni√®res valeurs
                    temperatureChart.data.labels = labels;
                    temperatureChart.data.datasets[0].data = data.temperature;
                    temperatureChart.update();

                    humiditeChart.data.labels = labels;
                    humiditeChart.data.datasets[0].data = data.humidity;
                    humiditeChart.update();

                    volumeChart.data.labels = labels;
                    volumeChart.data.datasets[0].data = data.volume;
                    volumeChart.update();
                });
            }

            // üü¢ √âtape 2 : Mettre √† jour les graphiques en temps r√©el avec /data
            function updateGraphs() {
                $.getJSON('/data', function(data) {
                    var now = new Date().toLocaleTimeString();
                
                    // üü¢ Prendre UNIQUEMENT la derni√®re valeur des tableaux re√ßus
                    var newTemperature = data.temperature[data.temperature.length - 1];
                    var newHumidity = data.humidity[data.humidity.length - 1];
                    var newVolume = data.volume[data.volume.length - 1];
                
                    // Ajout d'une seule nouvelle valeur aux graphiques
                    temperatureChart.data.labels.push(now);
                    temperatureChart.data.datasets[0].data.push(newTemperature);
                    if (temperatureChart.data.labels.length > 10) {
                        temperatureChart.data.labels.shift();
                        temperatureChart.data.datasets[0].data.shift();
                    }
                    temperatureChart.update();
                
                    humiditeChart.data.labels.push(now);
                    humiditeChart.data.datasets[0].data.push(newHumidity);
                    if (humiditeChart.data.labels.length > 10) {
                        humiditeChart.data.labels.shift();
                        humiditeChart.data.datasets[0].data.shift();
                    }
                    humiditeChart.update();
                
                    volumeChart.data.labels.push(now);
                    volumeChart.data.datasets[0].data.push(newVolume);
                    if (volumeChart.data.labels.length > 10) {
                        volumeChart.data.labels.shift();
                        volumeChart.data.datasets[0].data.shift();
                    }
                    volumeChart.update();
                });
            }

            // Charger imm√©diatement les 10 derni√®res valeurs
            loadInitialData();

            // Ensuite, mettre √† jour toutes les 2 secondes
            var interval = setInterval(updateGraphs, 2000);

            // Boutons de d√©marrage et d'arr√™t
            $("#dev_button_start").click(function () {
                clearInterval(interval);
                interval = setInterval(updateGraphs, 2000);
            });

            $("#dev_button_stop").click(function () {
                clearInterval(interval);
            });
        });

    </script>    
</head>
<body>

    <div id="logo">
        <a href="/">
            <img src="{{ url_for('static', filename='image/logo_accueil.png') }}" alt="Logo du site" title="Retour √† l'accueil">
        </a>
    </div>

    <h1>Entreprise ENPIWEN</h1>
    
    <form method="POST" action="{{ url_for('page_accueil') }}">
        <br>
        <button id="dev_button_start" type="button">D√©marrer l'actualisation</button>
        <button id="dev_button_stop" type="button">Arr√™ter l'actualisation</button>
        <br>
        
        <fieldset>
            <legend>Quel(s) graphique(s) voulez-vous r√©initialiser ?</legend>
            <label for="temp√©rature"> <input id="temp√©rature" type="checkbox" name="graphique" value="graph_1" class="inline" checked> Temp√©rature </label>
            <label for="humidit√©"> <input id="humidit√©" type="checkbox" name="graphique" value="graph_2" class="inline"> Humidit√© </label>
            <label for="son"> <input id="son" type="checkbox" name="graphique" value="graph_3" class="inline"> Son </label>
        </fieldset>
    </form>

    <div id="graph-container">
        <div class="graph-box">
            <canvas id="temperatureChart"></canvas>
        </div>
        <div class="graph-box">
            <canvas id="humiditeChart"></canvas>
        </div>
        <div class="graph-box">
            <canvas id="volumeChart"></canvas>
        </div>
    </div>  
</body>
</html>
